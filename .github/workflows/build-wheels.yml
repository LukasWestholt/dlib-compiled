name: Build dlib Wheels

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build_wheels:
    name: Build wheel for ${{ matrix.python[0] }}-${{ matrix.buildplat[1] }}
    runs-on: ${{ matrix.buildplat[0] }}

    strategy:
      fail-fast: false
      matrix:
        buildplat:
        - [ubuntu-24.04, manylinux_x86_64]
        - [ubuntu-24.04, musllinux_x86_64]
        - [ubuntu-24.04-arm, manylinux_aarch64]
        - [ubuntu-24.04-arm, musllinux_aarch64]
        - [macos-15-intel, macosx_x86_64]
        - [macos-15, macosx_arm64]
        - [windows-2025, win_amd64]
        - [windows-11-arm, win_arm64]
        python: [["cp38", "3.8"], ["cp39", "3.9"], ["cp310", "3.10"], ["cp311", "3.11"], ["cp312", "3.12"], ["cp313", "3.13"], ["cp314", "3.14"]]

    steps:
      - name: Checkout dlib
        uses: actions/checkout@v6
        with:
          repository: davisking/dlib
          fetch-depth: 0

      - name: Set up MSVC environment for ARM64
        if: matrix.buildplat[1] == 'win_arm64'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: arm64

      - name: Check Python libs
        if: matrix.buildplat[1] == 'win_arm64'
        run: |
          dir %PYTHONHOME%\libs
          dir %PYTHONHOME%

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # pip install build
      - name: Build wheel using cibuildwheel
        uses: pypa/cibuildwheel@v3.2.1
        env:
          CIBW_BUILD: ${{ matrix.python[0] }}-${{ matrix.buildplat[1] }}
          CIBW_BUILD_FRONTEND: ${{ matrix.cibw_build_frontend || 'pip' }}
          CIBW_PLATFORM: ${{ (matrix.buildplat[1] == 'pyodide_wasm32' && 'pyodide') || (matrix.buildplat[1] == 'win_arm64' && 'windows') || 'auto' }}
          CIBW_ARCHS: ${{ matrix.buildplat[1] == 'win_arm64' && 'ARM64' || 'auto' }}
          MACOSX_DEPLOYMENT_TARGET: 14.0
          # CIBW_BEFORE_BUILD_WINDOWS: 'python -m pip install delvewheel'

      - name: Set up Python for validation/upload (non-ARM64 Windows & other OS)
        # micromamba is not available for ARM64 Windows
        if: matrix.buildplat[1] != 'win_arm64'
        uses: mamba-org/setup-micromamba@v2
        with:
          environment-name: wheel-env
          # Use a fixed Python, since we might have an unreleased Python not
          # yet present on conda-forge
          create-args: >-
            python=3.11
            anaconda-client
            wheel
          cache-downloads: true
          cache-environment: true

      - name: Install wheel for win_arm64
        # installing wheel here because micromamba step was skipped
        if: matrix.buildplat[1] == 'win_arm64'
        shell: bash -el {0}
        run: python -m pip install wheel anaconda-client

      - name: Validate wheel RECORD
        shell: bash -el {0}
        run: for whl in $(ls wheelhouse); do wheel unpack wheelhouse/$whl -d /tmp; done

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ matrix.python[0] }}-${{ matrix.buildplat[1] }}
          path: ./wheelhouse/*.whl

  release:
    name: Create Release
    needs: build_wheels
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          name: wheels
          path: wheels

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "dlib Wheels ${{ github.ref_name }}"
          body: "Automated build of dlib wheels for multiple architectures and Python versions."
          files: wheels/*.whl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

